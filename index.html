<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポモドーロタイマー</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* Define CSS Custom Properties for theme colors */
        :root {
            --primary-color: #ef4444; /* Default Red */
            --primary-color-dark: #dc2626; /* Darker Red for hover */
            --secondary-period-color: #10b981; /* Green for break period */
        }

        /* General Body and Screen Layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px; /* Padding around the content */
            box-sizing: border-box;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .screen {
            background-color: #ffffff;
            border-radius: 16px; /* Material rounded corners */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Soft shadow for elevation */
            padding: 32px;
            width: 100%;
            max-width: 400px; /* Max width for mobile-first approach */
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* For settings button positioning */
            min-height: 400px; /* Ensure consistent card size */
        }

        .hidden {
            display: none !important;
        }

        /* Timer Screen specific styles */
        #timerScreen .timer-display {
            font-size: 6rem; /* Large timer font */
            font-weight: 700;
            color: var(--primary-color); /* Use custom property for theme color */
            margin-bottom: 24px;
            letter-spacing: -2px; /* Slight letter spacing adjustment */
        }

        .button-group {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center;
            gap: 16px; /* Space between buttons */
            margin-top: 24px;
        }

        .button-primary {
            background-color: var(--primary-color); /* Use custom property for theme color */
            color: white;
            padding: 16px 32px;
            border-radius: 32px; /* Pill-shaped button */
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
            outline: none;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .button-primary:hover {
            background-color: var(--primary-color-dark); /* Darker theme color on hover */
            transform: translateY(-2px);
        }

        .button-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .button-secondary {
            background-color: #6b7280; /* Grey secondary button */
            color: white;
            padding: 16px 24px; /* Slightly less padding for secondary action */
            border-radius: 32px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
            outline: none;
            white-space: nowrap;
        }

        .button-secondary:hover {
            background-color: #4b5563; /* Darker grey on hover */
            transform: translateY(-2px);
        }

        .button-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .settings-button, .home-screen-settings-button, .back-button-top {
            position: absolute;
            background-color: transparent;
            border: none;
            font-size: 2rem;
            color: #6b7280; /* Grey color for settings icon */
            cursor: pointer;
            transition: color 0.3s ease;
            outline: none;
        }

        .home-screen-settings-button {
            top: 20px;
            right: 20px;
        }

        .back-button-top {
            top: 20px;
            left: 20px;
            font-size: 1.5rem; /* Smaller icon for back button */
            padding: 8px; /* Add padding for easier tap */
            border-radius: 50%; /* Make it circular */
        }

        .settings-button:hover, .home-screen-settings-button:hover, .back-button-top:hover {
            color: #374151; /* Darker grey on hover */
        }

        /* Modal / Dialog Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #374151;
        }

        .modal-body label {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1.1rem;
            color: #4b5563;
        }

        .modal-body input[type="number"],
        .modal-body input[type="color"] { /* Style for color input */
            flex-grow: 1;
            margin-left: 10px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .modal-body input[type="color"] {
            padding: 0; /* Color input has different sizing */
            width: 50px; /* Adjust width for color picker */
            height: 40px; /* Adjust height for color picker */
            cursor: pointer;
        }

        .modal-body input[type="number"]:focus,
        .modal-body input[type="color"]:focus {
            border-color: var(--primary-color); /* Use custom property for focus border */
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3); /* Example: a blue shadow, or dynamically set via JS */
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }

        .modal-actions .button-cancel {
            background-color: #e5e7eb;
            color: #4b5563;
        }

        .modal-actions .button-cancel:hover {
            background-color: #d1d5db;
        }

        .modal-actions .button-save {
            background-color: var(--secondary-period-color); /* Green for save, consistent with break period */
            color: white;
        }

        .modal-actions .button-save:hover {
            background-color: #059669; /* Darker green on hover */
        }

        /* Custom Alert Dialog */
        .custom-alert-dialog {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }

        .custom-alert-dialog p {
            font-size: 1.1rem;
            margin-bottom: 24px;
            color: #374151;
        }

        /* Home Screen specific styles */
        #homeScreen .current-time {
            font-size: 4rem; /* Made clock bigger */
            font-weight: 600;
            color: #4b5563;
            margin-top: 20px; /* Adjusted margin for position */
            margin-bottom: 40px;
        }

        #homeScreen .home-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        #homeScreen .home-button {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 12px;
            font-size: 1.8rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
            outline: none;
            text-align: center;
        }

        #homeScreen .home-button:hover {
            background-color: var(--primary-color-dark);
            transform: translateY(-2px);
        }

        #homeScreen .home-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Records Screen specific styles */
        #recordsScreen .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }

        #recordsScreen .records-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #374151;
        }

        #recordsScreen .records-time-unit-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 20px;
            width: 100%;
        }

        #recordsScreen .records-time-unit-buttons button {
            background-color: #cbd5e1; /* Light grey */
            color: #374151;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            outline: none;
            transition: background-color 0.3s ease;
        }

        #recordsScreen .records-time-unit-buttons button.active {
            background-color: var(--primary-color);
            color: white;
        }
        #recordsScreen .records-time-unit-buttons button:hover:not(.active) {
            background-color: #a0aec0; /* Slightly darker */
        }

        .chart-scroll-container {
            width: 100%;
            overflow-x: auto; /* Enables horizontal scrolling */
            max-width: 100%; /* Ensure it doesn't overflow its parent */
            padding-bottom: 15px; /* Space for scrollbar */
        }
        #recordsChartCanvas {
            width: 100% !important; /* Start with 100% and let Chart.js adjust based on its options */
            height: 300px !important;
            min-width: 380px; /* Minimum width to prevent excessive squeezing for daily view */
        }

        /* Progress Bar styles */
        .progress-container {
            width: 90%; /* Adjust width relative to card */
            height: 12px;
            background-color: #e5e7eb;
            border-radius: 6px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Will be controlled by JS */
            background-color: var(--primary-color);
            border-radius: 6px;
            transition: width 0.9s linear; /* Smooth transition for progress */
        }
    </style>
</head>
<body>
    <!-- Home Screen -->
    <div id="homeScreen" class="screen">
        <button id="homeScreenSettingsButton" class="home-screen-settings-button">
            <i class="fas fa-cog"></i>
        </button>
        <div id="currentTimeDisplay" class="current-time"></div>
        <div class="home-buttons">
            <button id="focusButton" class="home-button">
                <i class="fas fa-brain"></i> 集中する
            </button>
            <button id="viewRecordsButton" class="home-button">
                <i class="fas fa-chart-bar"></i> 記録を見る
            </button>
        </div>
    </div>

    <!-- Timer Screen -->
    <div id="timerScreen" class="screen hidden">
        <!-- Back Button - Only visible when timer is not running -->
        <button id="backToHomeFromTimerButton" class="back-button-top">
            <i class="fas fa-arrow-left"></i>
        </button>

        <!-- Session Time Display -->
        <div id="currentSessionWorkTime" class="text-xl font-medium text-gray-700 mt-4">集中: 0分</div>
        <div id="currentSessionBreakTime" class="text-xl font-medium text-gray-700 mt-2">休憩: 0分</div>

        <!-- Timer Display -->
        <div id="timerDisplay" class="timer-display">25:00</div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div id="progressBarFill" class="progress-bar"></div>
        </div>

        <!-- Buttons Group -->
        <div class="button-group">
            <!-- Start/Pause Button -->
            <button id="startButton" class="button-primary">
                <i class="fas fa-play" id="startButtonIcon"></i>
                <span id="startButtonText">スタート</span>
            </button>
            <!-- Save Button - Only visible when timer is running or paused -->
            <button id="saveProgressButton" class="button-secondary hidden">
                <i class="fas fa-save"></i> 保存
            </button>
        </div>
    </div>

    <!-- Records Screen -->
    <div id="recordsScreen" class="screen hidden">
        <div class="records-header">
            <button id="backToHomeFromRecordsButton" class="back-button-top">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2>記録</h2>
        </div>
        <div class="records-time-unit-buttons">
            <button id="dailyViewButton" class="active">日単位</button>
            <button id="monthlyViewButton">月単位</button>
            <button id="yearlyViewButton">年単位</button>
        </div>
        <div class="chart-scroll-container">
            <canvas id="recordsChartCanvas"></canvas>
        </div>
        <p id="noDataMessage" class="text-gray-600 mt-4 hidden">まだ記録がありません。</p>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="modal-header">設定</h2>
            <div class="modal-body">
                <label>
                    作業時間:
                    <input type="number" id="workTimeInput" min="5" value="25">分
                </label>
                <label>
                    休憩時間:
                    <input type="number" id="breakTimeInput" min="1" value="5">分
                </label>
                <label>
                    テーマカラー:
                    <input type="color" id="themeColorInput" value="#ef4444">
                </label>
                <label class="flex-col items-start mt-4">
                    時計表示形式:
                    <div class="flex items-center mt-2">
                        <input type="radio" id="clockFormat24" name="clockFormat" value="24" class="mr-1"> <span class="text-base">24時間</span>
                        <input type="radio" id="clockFormat12" name="clockFormat" value="12" class="ml-6 mr-1"> <span class="text-base">12時間</span>
                    </div>
                </label>
            </div>
            <div class="modal-actions">
                <button class="button-cancel" id="cancelSettingsButton">キャンセル</button>
                <button class="button-save" id="saveSettingsButton">保存</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Dialog -->
    <div id="customAlertDialog" class="modal-overlay hidden">
        <div class="custom-alert-dialog">
            <p id="alertMessage"></p>
            <div class="modal-actions justify-center">
                <button class="button-cancel" id="alertCancelButton">いいえ</button>
                <button class="button-save" id="alertOkButton">はい</button>
            </div>
        </div>
    </div>

    <!-- アラーム音用のaudioタグを追加 -->
    <!-- SoundHelix提供のサンプルMP3を使用しています。必要に応じてURLを置き換えてください。 -->
    <audio id="alarmSound" src="https://pipocorp-japan.github.io/Pomodoro/alarm.mp3" preload="auto"></audio>

    <script> 
        // --- DOM Elements ---
const homeScreen = document.getElementById('homeScreen');
const timerScreen = document.getElementById('timerScreen');
const recordsScreen = document.getElementById('recordsScreen');
const focusButton = document.getElementById('focusButton');
const viewRecordsButton = document.getElementById('viewRecordsButton');
const backToHomeFromTimerButton = document.getElementById('backToHomeFromTimerButton');
const backToHomeFromRecordsButton = document.getElementById('backToHomeFromRecordsButton');
const noDataMessage = document.getElementById('noDataMessage');
const homeScreenSettingsButton = document.getElementById('homeScreenSettingsButton');
const currentTimeDisplay = document.getElementById('currentTimeDisplay');

const timerDisplay = document.getElementById('timerDisplay');
const startButton = document.getElementById('startButton');
const startButtonIcon = document.getElementById('startButtonIcon');
const startButtonText = document.getElementById('startButtonText');
const saveProgressButton = document.getElementById('saveProgressButton');
const settingsModal = document.getElementById('settingsModal');
const workTimeInput = document.getElementById('workTimeInput');
const breakTimeInput = document.getElementById('breakTimeInput');
const themeColorInput = document.getElementById('themeColorInput');
const clockFormat24 = document.getElementById('clockFormat24');
const clockFormat12 = document.getElementById('clockFormat12');
const saveSettingsButton = document.getElementById('saveSettingsButton');
const cancelSettingsButton = document.getElementById('cancelSettingsButton');

const customAlertDialog = document.getElementById('customAlertDialog');
const alertMessage = document.getElementById('alertMessage');
let alertOkButton = document.getElementById('alertOkButton');
let alertCancelButton = document.getElementById('alertCancelButton');

// Progress bar elements
const progressBarFill = document.getElementById('progressBarFill');

// Session time display elements
const currentSessionWorkTime = document.getElementById('currentSessionWorkTime');
const currentSessionBreakTime = document.getElementById('currentSessionBreakTime');

const recordsChartCanvas = document.getElementById('recordsChartCanvas');
let recordsChart; // To hold the Chart.js instance

// Records time unit buttons
const dailyViewButton = document.getElementById('dailyViewButton');
const monthlyViewButton = document.getElementById('monthlyViewButton');
const yearlyViewButton = document.getElementById('yearlyViewButton');

// --- Variables ---
let workTime = parseInt(localStorage.getItem('pomodoroWorkTime') || '25');
let breakTime = parseInt(localStorage.getItem('pomodoroBreakTime') || '5');
let themeColor = localStorage.getItem('pomodoroThemeColor') || '#ef4444';
let clockFormat = localStorage.getItem('pomodoroClockFormat') || '24'; // '24' or '12'
let currentTimeInSeconds = workTime * 60;
let totalPeriodSeconds = workTime * 60; // Total seconds for the current period
let isRunning = false;
let timerInterval = null; // Initialize to null
let isWorkPeriod = true; // true for work, false for break
let currentTimeInterval = null; // For home screen clock (global scope)

// Session accumulated times (reset on full cycle completion or manual save)
let sessionFocusedSeconds = 0; // Changed to seconds for more accurate tracking
let sessionBreakSeconds = 0; // Changed to seconds for more accurate tracking

const RECORDS_KEY = 'pomodoroRecords';
let currentChartTimeUnit = 'day'; // 'day', 'month', 'year'

// --- Audio ---
const alarmSound = document.getElementById('alarmSound'); // audio要素を取得
let audioUnlocked = false; // Add a flag to track if audio context is unlocked

function playAlarmSound() {
    // Only attempt to play if audio has been unlocked or is allowed
    if (audioUnlocked) {
        alarmSound.volume = 0.5;
        alarmSound.play().catch(error => {
            console.warn("アラーム音の再生に失敗しました:", error);
            // Optionally, inform the user if playback failed due to policy
            if (error.name === 'NotAllowedError') {
                showCustomAlertDialog('アラーム音の再生には、ページとのインタラクション（例: 開始ボタンのクリック）が必要です。', () => {}, () => {});
            }
        });
    } else {
        console.log("Audio not unlocked yet. Waiting for user interaction.");
        // If not unlocked, attempt to play quietly to unlock (some browsers might allow this)
        // Or, more robustly, rely on the click handler to unlock it
        alarmSound.volume = 0; // Play silently to try and unlock
        alarmSound.play().then(() => {
            alarmSound.pause();
            alarmSound.currentTime = 0;
            alarmSound.volume = 0.5; // Reset volume
            audioUnlocked = true;
            console.log("Audio unlocked silently.");
        }).catch(error => {
            console.warn("Silent audio unlock failed:", error);
        });
    }
}

// Function to unlock audio on first user interaction
function unlockAudio() {
    if (!audioUnlocked) {
        // Attempt to play a silent sound to unlock the audio context
        alarmSound.volume = 0;
        alarmSound.play().then(() => {
            alarmSound.pause();
            alarmSound.currentTime = 0;
            alarmSound.volume = 0.5; // Reset volume
            audioUnlocked = true;
            console.log("Audio unlocked by user interaction.");
        }).catch(error => {
            console.warn("Failed to unlock audio with user interaction:", error);
        });
    }
}

// --- Utility Functions ---
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
}

function formatCurrentTime(date) {
    let hours = date.getHours();
    const minutes = date.getMinutes();
    const seconds = date.getSeconds();
    let ampm = '';

    if (clockFormat === '12') {
        ampm = hours >= 12 ? ' PM' : ' AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // The hour '0' should be '12' in 12-hour format
    }

    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}${ampm}`;
}

function updateCurrentTimeDisplay() {
    const now = new Date();
    currentTimeDisplay.textContent = formatCurrentTime(now);
}

function setThemeColors(color) {
    document.documentElement.style.setProperty('--primary-color', color);
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);
    const darkerColor = `rgb(${Math.max(0, r - 30)}, ${Math.max(0, g - 30)}, ${Math.max(0, b - 30)})`;
    document.documentElement.style.setProperty('--primary-color-dark', darkerColor);
    document.documentElement.style.setProperty('--primary-color-rgb', `${r}, ${g}, ${b}`);

    // Update chart colors immediately if chart exists
    if (recordsChart) {
        const primaryColorCss = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
        const breakColorCss = getComputedStyle(document.documentElement).getPropertyValue('--secondary-period-color').trim();
        recordsChart.data.datasets[0].backgroundColor = primaryColorCss;
        recordsChart.data.datasets[1].backgroundColor = breakColorCss;
        recordsChart.update();
    }
}

function updateDisplay() {
    timerDisplay.textContent = formatTime(currentTimeInSeconds);

    totalPeriodSeconds = isWorkPeriod ? workTime * 60 : breakTime * 60;

    const progressPercentage = totalPeriodSeconds > 0 ? ((totalPeriodSeconds - currentTimeInSeconds) / totalPeriodSeconds) * 100 : 0;
    progressBarFill.style.width = `${progressPercentage}%`;
    progressBarFill.style.backgroundColor = isWorkPeriod ? 'var(--primary-color)' : 'var(--secondary-period-color)';

    timerDisplay.style.color = isWorkPeriod ? 'var(--primary-color)' : 'var(--secondary-period-color)';

    updateTimerButtonVisibility();

    let displayWorkMins = Math.floor(sessionFocusedSeconds / 60);
    let displayBreakMins = Math.floor(sessionBreakSeconds / 60);

    if (isRunning) {
        const elapsedSecondsThisPeriod = (totalPeriodSeconds - currentTimeInSeconds);
        if (isWorkPeriod) {
            displayWorkMins += Math.floor(elapsedSecondsThisPeriod / 60);
        } else {
            displayBreakMins += Math.floor(elapsedSecondsThisPeriod / 60);
        }
    }

    currentSessionWorkTime.textContent = `集中: ${displayWorkMins}分`;
    currentSessionBreakTime.textContent = `休憩: ${displayBreakMins}分`;
}

function updateTimerButtonVisibility() {
    if (timerInterval !== null) {
        saveProgressButton.classList.remove('hidden');
        backToHomeFromTimerButton.classList.add('hidden');
    } else {
        saveProgressButton.classList.add('hidden');
        backToHomeFromTimerButton.classList.remove('hidden');
    }
}

// --- Local Storage Management for Records ---
function getRecords() {
    try {
        const recordsJson = localStorage.getItem(RECORDS_KEY);
        return recordsJson ? JSON.parse(recordsJson) : [];
    } catch (e) {
        console.error("Error parsing records from localStorage", e);
        return [];
    }
}

function saveRecords(records) {
    try {
        localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
    } catch (e) {
        console.error("Error saving records to localStorage", e);
    }
}

function addRecord(type, durationMinutes) {
    if (durationMinutes <= 0 || isNaN(durationMinutes)) {
        return;
    }

    const today = new Date().toISOString().slice(0, 10);
    const records = getRecords();
    let recordFound = false;

    for (let i = 0; i < records.length; i++) {
        if (records[i].date === today) {
            if (type === 'work') {
                records[i].workMinutes = (records[i].workMinutes || 0) + durationMinutes;
            } else if (type === 'break') {
                records[i].breakMinutes = (records[i].breakMinutes || 0) + durationMinutes;
            }
            recordFound = true;
            break;
        }
    }

    if (!recordFound) {
        const newRecord = { date: today, workMinutes: 0, breakMinutes: 0 };
        if (type === 'work') {
            newRecord.workMinutes = durationMinutes;
        } else if (type === 'break') {
            newRecord.breakMinutes = durationMinutes;
        }
        records.push(newRecord);
    }

    records.sort((a, b) => new Date(a.date) - new Date(b.date));
    saveRecords(records);
}

// --- Timer Logic ---
// ... (既存のコード) ...

function startTimer() {
    // Attempt to unlock audio when the start button is clicked
    unlockAudio();

    if (isRunning) {
        clearInterval(timerInterval);
        isRunning = false;
        startButtonIcon.classList.remove('fa-pause');
        startButtonIcon.classList.add('fa-play');
        startButtonText.textContent = 'スタート';
    } else {
        isRunning = true;
        startButtonIcon.classList.remove('fa-play');
        startButtonIcon.classList.add('fa-pause');
        startButtonText.textContent = '一時停止';

        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            currentTimeInSeconds--;
            updateDisplay();

            if (currentTimeInSeconds <= 0) {
                playAlarmSound();
                clearInterval(timerInterval);
                timerInterval = null;

                // 期間が終了した際に、その期間の完了時間を累計に加算
                if (isWorkPeriod) {
                    sessionFocusedSeconds += workTime * 60; // 作業時間全体を累計
                } else {
                    sessionBreakSeconds += breakTime * 60; // 休憩時間全体を累計
                }

                // --- ここから修正 ---
                // 現在の期間の記録を保存
                addRecord(isWorkPeriod ? 'work' : 'break', isWorkPeriod ? workTime : breakTime);
                // --- 修正ここまで ---

                if (isWorkPeriod) {
                    // 作業期間が終了したら休憩期間へ
                    isWorkPeriod = false;
                    currentTimeInSeconds = breakTime * 60;
                    totalPeriodSeconds = breakTime * 60;
                    startTimer(); // 自動的に休憩タイマーを開始
                } else {
                    // 休憩期間が終了したら、次の集中期間のためにリセット
                    // リセットする前に現在のセッションの記録を保存
                    // NOTE: sessionFocusedSeconds と sessionBreakSeconds は既に加算済みなので、
                    // ここで再度 addRecord を呼ぶ必要はありません。
                    // resetTimer() の中でセッション累計時間をリセットします。

                    resetTimer(); // 次の作業期間のためにタイマーをリセット
                    showCustomAlertDialog('休憩が終了しました。新しい集中期間を開始しますか？', () => {
                        // 'はい' を選択した場合、特に何もしない（タイマーは既にリセット済み）
                    }, () => {
                        // 'いいえ' を選択した場合
                    });
                }
            }
        }, 1000);
    }
}

// ... (既存のコード) ...

function resetTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    isRunning = false;
    isWorkPeriod = true;
    currentTimeInSeconds = workTime * 60;

    // これらの変数がリセットされることが重要です
    sessionFocusedSeconds = 0;
    sessionBreakSeconds = 0;

    startButtonIcon.classList.remove('fa-pause');
    startButtonIcon.classList.add('fa-play');
    startButtonText.textContent = 'スタート';

    updateDisplay();
}

function saveProgress() {
    const elapsedSecondsThisPeriod = totalPeriodSeconds - currentTimeInSeconds;

    if (isWorkPeriod) {
        sessionFocusedSeconds += elapsedSecondsThisPeriod;
    } else {
        sessionBreakSeconds += elapsedSecondsThisPeriod;
    }

    if (sessionFocusedSeconds > 0) {
        addRecord('work', Math.floor(sessionFocusedSeconds / 60));
    }
    if (sessionBreakSeconds > 0) {
        addRecord('break', Math.floor(sessionBreakSeconds / 60));
    }

    resetTimer();
    showCustomAlertDialog('現在のセッションの集中時間と休憩時間を記録しました。', () => {}, () => {});
}

// --- Screen Navigation ---
function showScreen(screenToShow) {
    homeScreen.classList.add('hidden');
    timerScreen.classList.add('hidden');
    recordsScreen.classList.add('hidden');

    screenToShow.classList.remove('hidden');

    if (screenToShow === homeScreen) {
        clearInterval(currentTimeInterval);
        currentTimeInterval = setInterval(updateCurrentTimeDisplay, 1000);
        updateCurrentTimeDisplay();
    } else {
        clearInterval(currentTimeInterval);
    }

    if (screenToShow === recordsScreen) {
        renderChart(currentChartTimeUnit);
    }
}

// --- Custom Alert/Confirm Dialog Logic ---
let resolveAlertDialog;
function showCustomAlertDialog(message, onConfirm, onCancel) {
    alertMessage.textContent = message;
    customAlertDialog.classList.remove('hidden');

    // Remove previous event listeners to prevent multiple calls
    alertOkButton.onclick = null;
    alertCancelButton.onclick = null;

    alertOkButton.onclick = () => {
        customAlertDialog.classList.add('hidden');
        if (onConfirm) onConfirm();
    };

    alertCancelButton.onclick = () => {
        customAlertDialog.classList.add('hidden');
        if (onCancel) onCancel();
    };
}


// --- Chart Logic ---
function getChartData(timeUnit) {
    const records = getRecords();
    let labels = [];
    let workData = [];
    let breakData = [];
    let aggregatedData = {}; // To sum up minutes by day, month, or year

    records.forEach(record => {
        const recordDate = new Date(record.date);
        let key;

        if (timeUnit === 'day') {
            key = record.date;
        } else if (timeUnit === 'month') {
            key = recordDate.getFullYear() + '-' + String(recordDate.getMonth() + 1).padStart(2, '0');
        } else if (timeUnit === 'year') {
            key = String(recordDate.getFullYear());
        }

        if (!aggregatedData[key]) {
            aggregatedData[key] = { work: 0, break: 0 };
        }
        aggregatedData[key].work += (record.workMinutes || 0);
        aggregatedData[key].break += (record.breakMinutes || 0);
    });

    // Sort keys and populate labels and data arrays
    const sortedKeys = Object.keys(aggregatedData).sort();
    if (sortedKeys.length === 0) {
        return { labels: [], datasets: [] };
    }

    // Generate labels for the last 7 days, 12 months, or 5 years if data is sparse
    let generatedLabels = [];
    if (timeUnit === 'day') {
        for (let i = 6; i >= 0; i--) { // Last 7 days
            const d = new Date();
            d.setDate(d.getDate() - i);
            generatedLabels.push(d.toISOString().slice(0, 10));
        }
    } else if (timeUnit === 'month') {
        for (let i = 11; i >= 0; i--) { // Last 12 months
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            generatedLabels.push(d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0'));
        }
    } else if (timeUnit === 'year') {
        const currentYear = new Date().getFullYear();
        for (let i = 4; i >= 0; i--) { // Last 5 years
            generatedLabels.push(String(currentYear - i));
        }
    }

    labels = Array.from(new Set([...generatedLabels, ...sortedKeys])).sort(); // Combine and sort unique keys

    labels.forEach(label => {
        workData.push(aggregatedData[label] ? aggregatedData[label].work : 0);
        breakData.push(aggregatedData[label] ? aggregatedData[label].break : 0);
    });

    return { labels, workData, breakData };
}

function renderChart(timeUnit) {
    const { labels, workData, breakData } = getChartData(timeUnit);
    const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
    const breakColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-period-color').trim();

    if (recordsChart) {
        recordsChart.destroy(); // Destroy existing chart before creating a new one
    }

    if (labels.length === 0) {
        noDataMessage.classList.remove('hidden');
        recordsChartCanvas.classList.add('hidden');
        return;
    } else {
        noDataMessage.classList.add('hidden');
        recordsChartCanvas.classList.remove('hidden');
    }

    recordsChart = new Chart(recordsChartCanvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '集中時間 (分)',
                    data: workData,
                    backgroundColor: primaryColor,
                    borderColor: primaryColor,
                    borderWidth: 1
                },
                {
                    label: '休憩時間 (分)',
                    data: breakData,
                    backgroundColor: breakColor,
                    borderColor: breakColor,
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: timeUnit === 'day' ? '日付' : timeUnit === 'month' ? '月' : '年'
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '時間 (分)'
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });

    // Adjust chart width for daily view to prevent bars from being too thin
    if (timeUnit === 'day' && labels.length > 7) {
        recordsChartCanvas.style.width = `${labels.length * 50}px`; // Adjust 50px per bar as needed
    } else {
        recordsChartCanvas.style.width = '100%';
    }
}


// --- Event Listeners ---
focusButton.addEventListener('click', () => {
    showScreen(timerScreen);
    resetTimer(); // Ensure timer is reset when moving to timer screen
});

viewRecordsButton.addEventListener('click', () => {
    showScreen(recordsScreen);
    renderChart(currentChartTimeUnit); // Render chart when records screen is shown
});

backToHomeFromTimerButton.addEventListener('click', () => {
    // Only allow going back if the timer is not running
    if (!isRunning) {
        showScreen(homeScreen);
    } else {
        showCustomAlertDialog('タイマーが実行中です。ホーム画面に戻るには、タイマーを停止または保存してください。', () => {}, () => {
        });
    }
});

backToHomeFromRecordsButton.addEventListener('click', () => {
    showScreen(homeScreen);
});

homeScreenSettingsButton.addEventListener('click', () => {
    workTimeInput.value = workTime;
    breakTimeInput.value = breakTime;
    themeColorInput.value = themeColor;
    if (clockFormat === '24') {
        clockFormat24.checked = true;
    } else {
        clockFormat12.checked = true;
    }
    settingsModal.classList.remove('hidden');
});

cancelSettingsButton.addEventListener('click', () => {
    settingsModal.classList.add('hidden');
});

saveSettingsButton.addEventListener('click', () => {
    const newWorkTime = parseInt(workTimeInput.value);
    const newBreakTime = parseInt(breakTimeInput.value);
    const newThemeColor = themeColorInput.value;
    const newClockFormat = clockFormat24.checked ? '24' : '12';

    if (newWorkTime < 1 || newBreakTime < 1) {
        showCustomAlertDialog('作業時間と休憩時間は1分以上である必要があります。', () => {}, () => {});
        return;
    }

    workTime = newWorkTime;
    breakTime = newBreakTime;
    themeColor = newThemeColor;
    clockFormat = newClockFormat;

    localStorage.setItem('pomodoroWorkTime', workTime);
    localStorage.setItem('pomodoroBreakTime', breakTime);
    localStorage.setItem('pomodoroThemeColor', themeColor);
    localStorage.setItem('pomodoroClockFormat', clockFormat);

    setThemeColors(themeColor); // Apply new theme color
    resetTimer(); // Reset timer with new work/break times
    updateCurrentTimeDisplay(); // Update clock display with new format
    settingsModal.classList.add('hidden');
});

startButton.addEventListener('click', startTimer);
saveProgressButton.addEventListener('click', saveProgress);

// Records screen time unit buttons
dailyViewButton.addEventListener('click', () => {
    currentChartTimeUnit = 'day';
    dailyViewButton.classList.add('active');
    monthlyViewButton.classList.remove('active');
    yearlyViewButton.classList.remove('active');
    renderChart(currentChartTimeUnit);
});

monthlyViewButton.addEventListener('click', () => {
    currentChartTimeUnit = 'month';
    dailyViewButton.classList.remove('active');
    monthlyViewButton.classList.add('active');
    yearlyViewButton.classList.remove('active');
    renderChart(currentChartTimeUnit);
});

yearlyViewButton.addEventListener('click', () => {
    currentChartTimeUnit = 'year';
    dailyViewButton.classList.remove('active');
    monthlyViewButton.classList.remove('active');
    yearlyViewButton.classList.add('active');
    renderChart(currentChartTimeUnit);
});

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    setThemeColors(themeColor); // Apply initial theme
    updateDisplay(); // Initialize timer display
    showScreen(homeScreen); // Start on the home screen
    updateCurrentTimeDisplay(); // Display current time immediately
    currentTimeInterval = setInterval(updateCurrentTimeDisplay, 1000); // Start clock update interval

    // Add a global click listener to unlock audio as soon as possible
    document.body.addEventListener('click', unlockAudio, { once: true });
});
    </script>
</body>
</html>
