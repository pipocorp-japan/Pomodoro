<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ポモドーロ記録</title>
        <!-- Chart.js CDN -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            html, body {
                height: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background-color: transparent; /* 親の背景色を透過 */
                color: #ecf0f1;
                font-family: 'Inter', sans-serif;
            }

            body > button {
                background-color: #3498db; /* 青色 */
                color: white;
                border: none;
                border-radius: 10px;
                padding: 10px 20px;
                margin: 10px;
                font-size: 1em;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
                position: absolute; /* 絶対配置 */
                top: 20px; /* 上からの位置 */
                left: 20px; /* 左からの位置 */
            }

            body > button:hover {
                background-color: #2980b9;
                transform: translateY(-2px);
                box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
            }

            body > button svg {
                fill: #ecf0f1; /* SVGアイコンの色 */
                width: 20px;
                height: 20px;
            }

            h1 {
                font-size: 2.5em;
                margin-bottom: 30px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }

            #recordChartContainer {
                width: 80%; /* グラフコンテナの幅 */
                max-width: 600px; /* 最大幅 */
                background-color: rgba(0, 0, 0, 0.2); /* グラフの背景 */
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            }

            #recordChart {
                background-color: transparent; /* チャートの背景も透過 */
            }

            @media (max-width: 768px) {
                h1 {
                    font-size: 2em;
                }
                #recordChartContainer {
                    width: 90%;
                    padding: 15px;
                }
                body > button {
                    padding: 8px 15px;
                    font-size: 0.9em;
                    top: 15px;
                    left: 15px;
                }
                body > button svg {
                    width: 18px;
                    height: 18px;
                }
            }
        </style>
    </head>
    <body>
        <button type="button" id="back">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="m313-440 224 224-57 56-320-320 320-320 57 56-224 224h487v80H313Z"/></svg>
            戻る
        </button>
        <h1>ポモドーロ記録</h1>
        <div id="recordChartContainer">
            <canvas id="recordChart"></canvas>
        </div>

        <script>
            // record.htmlのJavaScript

            let myChart; // Chartインスタンスを保持する変数

            document.addEventListener('DOMContentLoaded', () => {
                const backBtn = document.getElementById('back');

                // 戻るボタンのイベントリスナー
                backBtn.addEventListener('click', () => {
                    // 親ウィンドウにhome.htmlに戻るようメッセージを送信
                    window.parent.postMessage({ type: 'backToHome' }, '*');
                });

                // 親ウィンドウから記録データとテーマカラーのメッセージを受け取る
                window.addEventListener('message', (event) => {
                    const message = event.data;

                    if (message.type === 'recordData') {
                        const completedPomodoros = message.completedPomodoros;
                        const themeColor = message.themeColor;
                        renderChart(completedPomodoros, themeColor);
                    } else if (message.type === 'applyTheme') {
                        // 親からテーマカラーが送られてきた場合、iframeのbodyにも適用
                        document.body.style.backgroundColor = message.color;
                        // グラフの色も更新（もしグラフが既に描画されていれば）
                        if (myChart) {
                            updateChartColors(myChart, message.color);
                            myChart.update();
                        }
                    }
                });

                // record.htmlがロードされたら、親に記録データを要求
                window.parent.postMessage({ type: 'requestRecordData' }, '*');
            });

            /**
             * 棒グラフを描画する
             * @param {number} completedPomodoros - 完了したポモドーロの回数
             * @param {string} themeColor - テーマカラー
             */
            function renderChart(completedPomodoros, themeColor) {
                const ctx = document.getElementById('recordChart').getContext('2d');

                // 既にChartインスタンスが存在する場合は破棄して再作成
                if (myChart) {
                    myChart.destroy();
                }

                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['完了したポモドーロ'],
                        datasets: [{
                            label: '回数',
                            data: [completedPomodoros],
                            backgroundColor: [
                                adjustColorOpacity(themeColor, 0.8) // テーマカラーを少し透過
                            ],
                            borderColor: [
                                themeColor
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // コンテナに合わせてサイズ調整
                        plugins: {
                            legend: {
                                display: false, // 凡例を非表示
                            },
                            title: {
                                display: true,
                                text: 'あなたのポモドーロ達成状況',
                                color: '#ecf0f1', // タイトル色
                                font: {
                                    size: 18
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#ecf0f1', // Y軸の目盛りテキスト色
                                    stepSize: 1, // 1単位で表示
                                    callback: function(value) {
                                        if (Number.isInteger(value)) {
                                            return value;
                                        }
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)' // Y軸のグリッド線色
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#ecf0f1' // X軸の目盛りテキスト色
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)' // X軸のグリッド線色
                                }
                            }
                        }
                    }
                });
            }

            /**
             * 色の透明度を調整するヘルパー関数
             * @param {string} hex - 16進数の色コード (例: #RRGGBB)
             * @param {number} opacity - 透明度 (0.0 から 1.0)
             * @returns {string} RGBA形式の色コード
             */
            function adjustColorOpacity(hex, opacity) {
                let c;
                if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                    c= hex.substring(1).split('');
                    if(c.length===3){
                        c= [c[0], c[0], c[1], c[1], c[2], c[2]];
                    }
                    c= '0x'+c.join('');
                    return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+opacity+')';
                }
                throw new Error('Bad Hex');
            }

            /**
             * グラフの色を更新する
             * @param {Chart} chart - Chart.js インスタンス
             * @param {string} newColor - 新しいテーマカラー
             */
            function updateChartColors(chart, newColor) {
                chart.data.datasets.forEach(dataset => {
                    dataset.backgroundColor = [adjustColorOpacity(newColor, 0.8)];
                    dataset.borderColor = [newColor];
                });
            }
        </script>
    </body>
</html>
